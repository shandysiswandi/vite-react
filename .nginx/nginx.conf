# Include the file defining MIME types.
include       /etc/nginx/mime.types;

# --- Logging ---
access_log /dev/stdout;
error_log  /dev/stderr warn;

# --- Security Headers ---
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;" always;

tcp_nopush on;
server_tokens off;

# --- Gzip Compression ---
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_types
    text/plain
    text/css
    application/json
    application/javascript
    application/x-javascript
    text/xml
    application/xml
    application/xml+rss
    text/javascript
    image/svg+xml;

# --- Brotli Compression (Optional, if installed) ---
# brotli on;
# brotli_comp_level 6;
# brotli_types
#     text/plain
#     text/css
#     application/json
#     application/javascript
#     application/x-javascript
#     text/xml
#     application/xml
#     application/xml+rss
#     text/javascript
#     image/svg+xml;

server {
    listen 80;
    # For production, you would replace 'localhost' with your domain name.
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # --- SPA Routing ---
    # This is the key for single-page applications like React.
    # It serves the requested file if it exists, otherwise falls back to index.html.
    location / {
        try_files $uri $uri/ /index.html;
    }

    # --- Caching ---
    # Cache static assets with hashes in their filenames (e.g., in /assets/) for one year.
    # These files are considered immutable.
    location ~* \.(?:js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Cache other static assets (images, fonts) for a shorter period.
    location ~* \.(?:jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1M;
        add_header Cache-Control "public";
    }

    autoindex off;

    # --- Conditional Headers for Better Caching (Optional) ---
    add_header Last-Modified $date_gmt;
    add_header ETag $upstream_http_etag;
    if_modified_since exact;
    etag on;
}
